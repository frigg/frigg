{% extends "base.html" %}
{% load i18n %}

{% block js %}
  {{ block.super }}
  <script src="{{ STATIC_URL }}js/ansi_up.js"></script>
  <script src="{{ STATIC_URL }}js/colorify.js"></script>
  <script src="{{ STATIC_URL }}js/builds.js"></script>
  {% if not build.result %}
    <script>
      $(document).ready(function() {
        setInterval(function () {
          $.getJSON('/api/builds/{{ build.pk }}/', function (build) {
            if(build.result) window.location = '{% url 'view_build' build.project.owner build.project.name build.build_number %}';
          });
        }, 1000);
      });
    </script>
  {% endif %}

  <script>
    $('.build-logs h3').on('click', function() {
      $(this).parent().find('pre').slideToggle();
    });
  </script>
{% endblock js %}

{% block content %}
  <div class="pure-u-1">
    <h3>
      {{ build.project.owner }} / {{ build.project.name }} / {{ build.branch }}
      <a href="{{ build.pull_request_url }}" class="no-underline"><i class="fa fa-github"></i></a>
    </h3>
  </div>

  <div class="pure-u-1 pure-u-lg-1-2">
    <strong>{% trans 'Branch' %}:</strong> {{ build.branch }} <br/>
    <strong>{% trans 'Commit hash' %}:</strong> {{ build.sha }} <br/>
    {% if build.author %}
      <strong>{% trans 'Author' %}:</strong> {{ build.author }} <br/>
    {% endif %}
    <strong>{% trans 'Timestamp' %}:</strong> <span class="timestamp">{{ build.created_at }}</span> <br/>
    {% if build.result.coverage %}
      <strong>{% trans 'Coverage' %}:</strong> {{ build.result.coverage }}% <br/>
      <strong>{% trans 'Coverage difference from last master build' %}:</strong>
      {% if build.result.coverage_diff > 0 %} + {% endif %}
      {{ build.result.coverage_diff }}% <br/>
    {% endif %}
    <strong>{% trans 'State' %}:</strong>
    {% if not build.result %}
      {% trans 'pending' %}
    {% elif build.result.succeeded %}
      {% trans 'success' %}
    {% else %}
      {% trans 'failure' %}
    {% endif %}
  </div>

  <div class="pure-u-1 pure-u-lg-1-2">
    {% if build.message %}
      <strong>Message:</strong><br/>
      {{ build.rendered_message }}
    {% endif %}
  </div>

  <div class="pure-u-1">
    {% if build.is_pending %}
      {% include "builds/partials/loading.html" %}
    {% else %}
      <div class="build-logs">
        {% for task, log, return_code in build.result.tasks %}
          <div>
            <h3>{{ task }} <span class="meta">Return code: {{ return_code }}</span></h3>
            <pre{% if return_code == '' or return_code == '0' and 'install' in task %} style="display: none;"{% endif %}> <code class="colorify">{{ log }}</code> </pre>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  </div>

{% endblock %}
